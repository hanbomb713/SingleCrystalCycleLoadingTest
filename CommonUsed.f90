!*********************************************************************
!  This file contains subroutines that are commonly used by others,  *
!  such as getshape.                                                 *
!*********************************************************************
!===============================================================
SUBROUTINE GETSHAPE(SHAP,UU)
	use ZQMPI
	IMPLICIT NONE
	DOUBLE PRECISION, DIMENSION(4,3)::SHAP
	DOUBLE PRECISION::UU

	SHAP(1,1) = 2*UU**3-3*UU*UU+1
	SHAP(2,1) = UU**3-2*UU*UU+UU
	SHAP(3,1) =-2*UU**3+3*UU*UU
	SHAP(4,1) = UU**3-UU*UU

	SHAP(1,2)= 6*UU*UU-6*UU
	SHAP(2,2)=3*UU*UU-4*UU+1
	SHAP(3,2)=-6*UU*UU+6*UU
	SHAP(4,2)=3*UU*UU-2*UU

	SHAP(1,3)= 12*UU-6
	SHAP(2,3)=6*UU-4
	SHAP(3,3)=-12*UU+6
	SHAP(4,3)=6*UU-2

END SUBROUTINE GETSHAPE

!***************************************************************
!  quadrature:
!		Gauss Quadrature Points for integration.
!***************************************************************
SUBROUTINE quadrature
	use ZQMPI
	USE VARIABLES,only:POS,wt,MAX_QUAD
	implicit none

	integer::i,j
	
	i=MAX_QUAD

	if (i>64) then
		j=128
	else if (i>32) then
		j=64
	else if (i>16) then
		j=32
	else if (i<2) then
		j=2
	else
		j=i
	end if

	MAX_QUAD=j
	
	select case (j)

	case (2)

	pos(1)= -0.577350269189626; 	wt(1)= 1.000000000000000
	pos(2)=  0.577350269189626; 	wt(2)= 1.000000000000000

	case (3)

	pos(1)=-0.774596669241483;	wt(1)=	0.555555555555556
	pos(2)= 0.000000000000000;	wt(2)=	0.888888888888889
	pos(3)= 0.774596669241483;	wt(3)=  0.555555555555556

	case(4)

	pos(1)=-0.861136311594053;	wt(1)=	0.347854845137454
	pos(2)=-0.339981043584856;	wt(2)=	0.652145154862546
	pos(3)= 0.339981043584856;	wt(3)=	0.652145154862546
	pos(4)= 0.861136311594053;	wt(4)=	0.347854845137454

	case(5)

	pos(1)=-0.906179845938664;	wt(1)=	0.236926885056189
	pos(2)=-0.538469310105683;	wt(2)=	0.478628670499366
	pos(3)= 0.000000000000000;	wt(3)=	0.568888888888889
	pos(4)= 0.538469310105683;	wt(4)=	0.478628670499366
	pos(5)= 0.906179845938664;	wt(5)=	0.236926885056189

	case(6)

	pos(1)=-0.932469514203152;	wt(1)=	0.171324492379170
	pos(2)=-0.661209386466265;	wt(2)=	0.360761573048139
	pos(3)=-0.238619186083197;	wt(3)=	0.467913934572691
	pos(4)= 0.238619186083197;	wt(4)=	0.467913934572691
	pos(5)= 0.661209386466265;	wt(5)=	0.360761573048139
	pos(6)= 0.932469514203152;	wt(6)=	0.171324492379170

	case(7)

	pos(1)=-0.949107912342759;	wt(1)= 	0.129484966168870
	pos(2)=-0.741531185599394;	wt(2)=	0.279705391489277
	pos(3)=-0.405845151377397;	wt(3)=	0.381830050505119
	pos(4)= 0.000000000000000;	wt(4)=	0.417959183673469
	pos(5)= 0.405845151377397;	wt(5)=	0.381830050505119
	pos(6)= 0.741531185599394;	wt(6)=	0.279705391489277
	pos(7)= 0.949107912342759;	wt(7)= 	0.129484966168870

	case(8)

	pos(1)=-0.960289856497536;	wt(1)=	0.101228536290376
	pos(2)=-0.796666477413627;	wt(2)=	0.222381034453374
	pos(3)=-0.525532409916329;	wt(3)=	0.313706645877887
	pos(4)=-0.183434642495650;	wt(4)=	0.362683783378362
	pos(5)= 0.183434642495650;	wt(5)=	0.362683783378362	 
	pos(6)= 0.525532409916329;	wt(6)=	0.313706645877887
	pos(7)= 0.796666477413627;	wt(7)=	0.222381034453374
	pos(8)= 0.960289856497536;	wt(8)=	0.101228536290376

	case (9)

	pos(1)=-0.968160239507626;	wt(1)=	0.081274388361574
	pos(2)=-0.836031107326636;	wt(2)=	0.180648160694857
	pos(3)=-0.613371432700590;	wt(3)=	0.260610696402935
	pos(4)=-0.324253423403809;	wt(4)=	0.312347077040003
	pos(5)= 0.000000000000000;	wt(5)=	0.330239355001260
	pos(6)= 0.324253423403809;	wt(6)=	0.312347077040003
	pos(7)= 0.613371432700590;	wt(7)=	0.260610696402935
	pos(8)= 0.836031107326636;	wt(8)=	0.180648160694857
	pos(9)= 0.968160239507626;	wt(9)=	0.081274388361574

	case (10)

	pos(1)=-0.973906528517172;	wt(1)=	0.066671344308668
	pos(2)=-0.865063366688985;	wt(2)=	0.149451349150581
	pos(3)=-0.679409568299024;	wt(3)=	0.219086362515982
	pos(4)=-0.433395394129247;	wt(4)=	0.269266719309996
	pos(5)=-0.148874338981631;	wt(5)=	0.295524224714753
	pos(6)= 0.148874338981631;	wt(6)=	0.295524224714753
	pos(7)= 0.433395394129247;	wt(7)=	0.269266719309996
	pos(8)= 0.679409568299024;	wt(8)=	0.219086362515982
	pos(9)= 0.865063366688985;	wt(9)=	0.149451349150581
	pos(10)=0.973906528517172;	wt(10)=	0.066671344308668


	case (11)

	pos(1)=-0.978228658146057;	wt(1)=	0.055668567116174
	pos(2)=-0.887062599768095;	wt(2)=	0.125580369464905
	pos(3)=-0.730152005574049;	wt(3)=	0.186290210927734
	pos(4)=-0.519096129206812;	wt(4)=	0.233193764591990
	pos(5)=-0.269543155952345;	wt(5)=	0.262804544510247
	pos(6)= 0.000000000000000;	wt(6)=	0.272925086777901	
	pos(7)= 0.269543155952345;	wt(7)=	0.262804544510247
	pos(8)= 0.519096129206812;	wt(8)=	0.233193764591990
	pos(9)= 0.730152005574049;	wt(9)= 	0.186290210927734
	pos(10)=0.887062599768095;	wt(10)=	0.125580369464905
	pos(11)=0.978228658146057;	wt(11)=	0.055668567116174

	case (12)

	pos(1)=-0.981560634246719;	wt(1)=	0.047175336386512
	pos(2)=-0.904117256370475;	wt(2)=	0.106939325995318
	pos(3)=-0.769902674194305;	wt(3)=	0.160078328543346
	pos(4)=-0.587317954286617;	wt(4)=	0.203167426723066
	pos(5)=-0.367831498998180;	wt(5)=	0.233492536538355
	pos(6)=-0.125233408511469;	wt(6)=	0.249147045813403 
	pos(7)= 0.125233408511469;	wt(7)=	0.249147045813403
	pos(8)= 0.367831498998180;	wt(8)=	0.233492536538355
	pos(9)= 0.587317954286617;	wt(9)=	0.203167426723066
	pos(10)=0.769902674194305;	wt(10)=	0.160078328543346
	pos(11)=0.904117256370475;	wt(11)=	0.106939325995318
	pos(12)=0.981560634246719;	wt(12)=	0.047175336386512

	case (13)

	pos(1)=-0.984183054718588;	wt(1)=	0.040484004765316
	pos(2)=-0.917598392222975;	wt(2)=	0.092121498837728
	pos(3)=-0.801578090733310;	wt(3)=	0.138873510219787
	pos(4)=-0.642349339440340;	wt(4)=	0.178145980761946
	pos(5)=-0.448492751036447;	wt(5)=	0.207816047536889
	pos(6)=-0.230458315955135;	wt(6)=	0.226283180262897
	pos(7)= 0.000000000000000;	wt(7)=	0.232551553230874
	pos(8)= 0.230458315955135;	wt(8)=	0.226283180262897
	pos(9)= 0.448492751036447;	wt(9)=	0.207816047536889
	pos(10)=0.642349339440340;	wt(10)=	0.178145980761946
	pos(11)=0.801578090733310;	wt(11)=	0.138873510219787
	pos(12)=0.917598392222975;	wt(12)=	0.092121498837728
	pos(13)=0.984183054718588;	wt(13)=	0.040484004765316

	case (14)

	pos(1)=-0.986283808696812;	wt(1)=	0.035119460331752
	pos(2)=-0.928434883663574;	wt(2)=	0.080158087159760
	pos(3)=-0.827201315069765;	wt(3)=	0.121518570687903
	pos(4)=-0.687292904811685;	wt(4)=	0.157203167158194
	pos(5)=-0.515248636358154;	wt(5)=	0.185538397477938
	pos(6)=-0.319112368927890;	wt(6)=	0.205198463721296
	pos(7)=-0.108054948707344;	wt(7)=	0.215263853463158
	pos(8)= 0.108054948707344;	wt(8)=	0.215263853463158
	pos(9)= 0.319112368927890;	wt(9)=	0.205198463721296
	pos(10)=0.515248636358154;	wt(10)=	0.185538397477938
	pos(11)=0.687292904811685;	wt(11)=	0.157203167158194
	pos(12)=0.827201315069765;	wt(12)=	0.121518570687903
	pos(13)=0.928434883663574;	wt(13)=	0.080158087159760
	pos(14)=0.986283808696812;	wt(14)=	0.035119460331752

	case (15)

	pos(1)=-0.987992518020485;	wt(1)=	0.030753241996117
	pos(2)=-0.937273392400706;	wt(2)=	0.070366047488108
	pos(3)=-0.848206583410427;	wt(3)=	0.107159220467172
	pos(4)=-0.724417731360170;	wt(4)=	0.139570677926154
	pos(5)=-0.570972172608539;	wt(5)=	0.166269205816994
	pos(6)=-0.394151347077563;	wt(6)=	0.186161000015562
	pos(7)=-0.201194093997435;	wt(7)=	0.198431485327112
	pos(8)= 0.000000000000000;	wt(8)=	0.202578241925561
	pos(9)= 0.201194093997435;	wt(9)=	0.198431485327112
	pos(10)=0.394151347077563;	wt(10)=	0.186161000015562
	pos(11)=0.570972172608539;	wt(11)=	0.166269205816994
	pos(12)=0.724417731360170;	wt(12)=	0.139570677926154
	pos(13)=0.848206583410427;	wt(13)=	0.107159220467172
	pos(14)=0.937273392400706;	wt(14)=	0.070366047488108
	pos(15)=0.987992518020485;	wt(15)=	0.030753241996117

	case (16)

	pos(1)=-0.989400934991650;	wt(1)=	0.027152459411754
	pos(2)=-0.944575023073233;	wt(2)=	0.062253523938648
	pos(3)=-0.865631202387832;	wt(3)=	0.095158511682493
	pos(4)=-0.755404408355003;	wt(4)=	0.124628971255534
	pos(5)=-0.617876244402644;	wt(5)=	0.149595988816577
	pos(6)=-0.458016777657227;	wt(6)=	0.169156519395003
	pos(7)=-0.281603550779259;	wt(7)=	0.182603415044924
	pos(8)=-0.095012509837637;	wt(8)=	0.189450610455068
	pos(9)= 0.095012509837637;	wt(9)=	0.189450610455068
	pos(10)=0.281603550779259;	wt(10)=	0.182603415044924
	pos(11)=0.458016777657227;	wt(11)=	0.169156519395003
	pos(12)=0.617876244402644;	wt(12)=	0.149595988816577
	pos(13)=0.755404408355003;	wt(13)=	0.124628971255534
	pos(14)=0.865631202387832;	wt(14)=	0.095158511682493
	pos(15)=0.944575023073233;	wt(15)=	0.062253523938648
	pos(16)=0.989400934991650;	wt(16)=	0.027152459411754

	case (32)

	pos( 1)=  -.997263861849482;    wt( 1)=   .007018610009470
	pos( 2)=  -.985611511545269;    wt( 2)=   .016274394730906
	pos( 3)=  -.964762255587506;    wt( 3)=   .025392065309262
	pos( 4)=  -.934906075937740;    wt( 4)=   .034273862913020
	pos( 5)=  -.896321155766052;    wt( 5)=   .042835898022227
	pos( 6)=  -.849367613732570;    wt( 6)=   .050998059262376
	pos( 7)=  -.794483795967942;    wt( 7)=   .058684093478535
	pos( 8)=  -.732182118740290;    wt( 8)=   .065822222776362
	pos( 9)=  -.663044266930215;    wt( 9)=   .072345794108850
	pos(10)=  -.587715757240762;    wt(10)=   .078193895787070
	pos(11)=  -.506899908932229;    wt(11)=   .083311924226945
	pos(12)=  -.421351276130636;    wt(12)=   .087652093004404
	pos(13)=  -.331868602282128;    wt(13)=   .091173878695764
	pos(14)=  -.239287362252137;    wt(14)=   .093844399080805
	pos(15)=  -.144471961582796;    wt(15)=   .095638720079274
	pos(16)=  -.048307665687738;    wt(16)=   .096540088514728
	pos(17)=   .048307665687738;    wt(17)=   .096540088514728
	pos(18)=   .144471961582797;    wt(18)=   .095638720079275
	pos(19)=   .239287362252137;    wt(19)=   .093844399080805
	pos(20)=   .331868602282128;    wt(20)=   .091173878695764
	pos(21)=   .421351276130635;    wt(21)=   .087652093004403
	pos(22)=   .506899908932229;    wt(22)=   .083311924226947
	pos(23)=   .587715757240762;    wt(23)=   .078193895787070
	pos(24)=   .663044266930215;    wt(24)=   .072345794108848
	pos(25)=   .732182118740289;    wt(25)=   .065822222776362
	pos(26)=   .794483795967942;    wt(26)=   .058684093478536
	pos(27)=   .849367613732570;    wt(27)=   .050998059262375
	pos(28)=   .896321155766052;    wt(28)=   .042835898022227
	pos(29)=   .934906075937740;    wt(29)=   .034273862913022
	pos(30)=   .964762255587506;    wt(30)=   .025392065309262
	pos(31)=   .985611511545268;    wt(31)=   .016274394730905
	pos(32)=   .997263861849481;    wt(32)=   .007018610009470

	case (64)

	pos( 1)=  -.999305041735772;    wt( 1)=   .001783280721697
	pos( 2)=  -.996340116771955;    wt( 2)=   .004147033260562
	pos( 3)=  -.991013371476744;    wt( 3)=   .006504457968979
	pos( 4)=  -.983336253884626;    wt( 4)=   .008846759826364
	pos( 5)=  -.973326827789911;    wt( 5)=   .011168139460131
	pos( 6)=  -.961008799652054;    wt( 6)=   .013463047896719
	pos( 7)=  -.946411374858403;    wt( 7)=   .015726030476023
	pos( 8)=  -.929569172131939;    wt( 8)=   .017951715775697
	pos( 9)=  -.910522137078502;    wt( 9)=   .020134823153531
	pos(10)=  -.889315445995114;    wt(10)=   .022270173808383
	pos(11)=  -.865999398154093;    wt(11)=   .024352702568711
	pos(12)=  -.840629296252580;    wt(12)=   .026377469715055
	pos(13)=  -.813265315122797;    wt(13)=   .028339672614259
	pos(14)=  -.783972358943341;    wt(14)=   .030234657072403
	pos(15)=  -.752819907260532;    wt(15)=   .032057928354852
	pos(16)=  -.719881850171611;    wt(16)=   .033805161837141
	pos(17)=  -.685236313054233;    wt(17)=   .035472213256883
	pos(18)=  -.648965471254657;    wt(18)=   .037055128540240
	pos(19)=  -.611155355172394;    wt(19)=   .038550153178615
	pos(20)=  -.571895646202634;    wt(20)=   .039953741132720
	pos(21)=  -.531279464019895;    wt(21)=   .041262563242625
	pos(22)=  -.489403145707052;    wt(22)=   .042473515123654
	pos(23)=  -.446366017253464;    wt(23)=   .043583724529323
	pos(24)=  -.402270157963991;    wt(24)=   .044590558163757
	pos(25)=  -.357220158337668;    wt(25)=   .045491627927418
	pos(26)=  -.311322871990211;    wt(26)=   .046284796581314
	pos(27)=  -.264687162208767;    wt(27)=   .046968182816209
	pos(28)=  -.217423643740007;    wt(28)=   .047540165714831
	pos(29)=  -.169644420423993;    wt(29)=   .047999388596458
	pos(30)=  -.121462819296121;    wt(30)=   .048344762234804
	pos(31)=  -.072993121787799;    wt(31)=   .048575467441504
	pos(32)=  -.024350292663424;    wt(32)=   .048690957009140
	pos(33)=   .024350292663425;    wt(33)=   .048690957009139
	pos(34)=   .072993121787799;    wt(34)=   .048575467441503
	pos(35)=   .121462819296120;    wt(35)=   .048344762234803
	pos(36)=   .169644420423993;    wt(36)=   .047999388596458
	pos(37)=   .217423643740007;    wt(37)=   .047540165714831
	pos(38)=   .264687162208767;    wt(38)=   .046968182816210
	pos(39)=   .311322871990211;    wt(39)=   .046284796581314
	pos(40)=   .357220158337668;    wt(40)=   .045491627927417
	pos(41)=   .402270157963991;    wt(41)=   .044590558163758
	pos(42)=   .446366017253464;    wt(42)=   .043583724529324
	pos(43)=   .489403145707053;    wt(43)=   .042473515123653
	pos(44)=   .531279464019895;    wt(44)=   .041262563242624
	pos(45)=   .571895646202634;    wt(45)=   .039953741132721
	pos(46)=   .611155355172393;    wt(46)=   .038550153178616
	pos(47)=   .648965471254657;    wt(47)=   .037055128540241
	pos(48)=   .685236313054233;    wt(48)=   .035472213256881
	pos(49)=   .719881850171611;    wt(49)=   .033805161837142
	pos(50)=   .752819907260532;    wt(50)=   .032057928354852
	pos(51)=   .783972358943342;    wt(51)=   .030234657072402
	pos(52)=   .813265315122797;    wt(52)=   .028339672614259
	pos(53)=   .840629296252580;    wt(53)=   .026377469715055
	pos(54)=   .865999398154092;    wt(54)=   .024352702568711
	pos(55)=   .889315445995114;    wt(55)=   .022270173808382
	pos(56)=   .910522137078503;    wt(56)=   .020134823153530
	pos(57)=   .929569172131940;    wt(57)=   .017951715775697
	pos(58)=   .946411374858403;    wt(58)=   .015726030476025
	pos(59)=   .961008799652054;    wt(59)=   .013463047896719
	pos(60)=   .973326827789911;    wt(60)=   .011168139460130
	pos(61)=   .983336253884626;    wt(61)=   .008846759826364
	pos(62)=   .991013371476744;    wt(62)=   .006504457968979
	pos(63)=   .996340116771955;    wt(63)=   .004147033260562
	pos(64)=   .999305041735772;    wt(64)=   .001783280721697

	case (128)

	pos(  1)=  -.999824887947132;    wt(  1)=   .000449380960291
	pos(  2)=  -.999077459977377;    wt(  2)=   .001045812679341
	pos(  3)=  -.997733248625515;    wt(  3)=   .001642503018669
	pos(  4)=  -.995792758534981;    wt(  4)=   .002238288430963
	pos(  5)=  -.993257112900213;    wt(  5)=   .002832751471457
	pos(  6)=  -.990127818491735;    wt(  6)=   .003425526040911
	pos(  7)=  -.986406742724587;    wt(  7)=   .004016254983738
	pos(  8)=  -.982096108435719;    wt(  8)=   .004604584256703
	pos(  9)=  -.977198491463908;    wt(  9)=   .005190161832676
	pos( 10)=  -.971716818747136;    wt( 10)=   .005772637542867
	pos( 11)=  -.965654366431966;    wt( 11)=   .006351663161706
	pos( 12)=  -.959014757853700;    wt( 12)=   .006926892566899
	pos( 13)=  -.951801961341265;    wt( 13)=   .007497981925635
	pos( 14)=  -.944020287830221;    wt( 14)=   .008064589890485
	pos( 15)=  -.935674388277917;    wt( 15)=   .008626377798618
	pos( 16)=  -.926769250878948;    wt( 16)=   .009183009871660
	pos( 17)=  -.917310198080961;    wt( 17)=   .009734153415007
	pos( 18)=  -.907302883401757;    wt( 18)=   .010279479015831
	pos( 19)=  -.896753288049158;    wt( 19)=   .010818660739503
	pos( 20)=  -.885667717345397;    wt( 20)=   .011351376324079
	pos( 21)=  -.874052796958032;    wt( 21)=   .011877307372741
	pos( 22)=  -.861915468939548;    wt( 22)=   .012396139543952
	pos( 23)=  -.849262987577969;    wt( 23)=   .012907562739267
	pos( 24)=  -.836102915060907;    wt( 24)=   .013411271288616
	pos( 25)=  -.822443116955644;    wt( 25)=   .013906964132952
	pos( 26)=  -.808291757507913;    wt( 26)=   .014394345004168
	pos( 27)=  -.793657294762193;    wt( 27)=   .014873122602147
	pos( 28)=  -.778548475506411;    wt( 28)=   .015343010768865
	pos( 29)=  -.762974330044094;    wt( 29)=   .015803728659399
	pos( 30)=  -.746944166797062;    wt( 30)=   .016255000909785
	pos( 31)=  -.730467566741909;    wt( 31)=   .016696557801589
	pos( 32)=  -.713554377683587;    wt( 32)=   .017128135423111
	pos( 33)=  -.696214708369514;    wt( 33)=   .017549475827118
	pos( 34)=  -.678458922447719;    wt( 34)=   .017960327185008
	pos( 35)=  -.660297632272646;    wt( 35)=   .018360443937331
	pos( 36)=  -.641741692562308;    wt( 36)=   .018749586940545
	pos( 37)=  -.622802193910585;    wt( 37)=   .019127523609951
	pos( 38)=  -.603490456158549;    wt( 38)=   .019494028058706
	pos( 39)=  -.583818021628764;    wt( 39)=   .019848881232830
	pos( 40)=  -.563796648226618;    wt( 40)=   .020191871042132
	pos( 41)=  -.543438302412811;    wt( 41)=   .020522792486959
	pos( 42)=  -.522755152051176;    wt( 42)=   .020841447780752
	pos( 43)=  -.501759559136145;    wt( 43)=   .021147646468221
	pos( 44)=  -.480464072404172;    wt( 44)=   .021441205539209
	pos( 45)=  -.458881419833553;    wt( 45)=   .021721949538052
	pos( 46)=  -.437024501037105;    wt( 46)=   .021989710668461
	pos( 47)=  -.414906379552274;    wt( 47)=   .022244328893799
	pos( 48)=  -.392540275033268;    wt( 48)=   .022485652032746
	pos( 49)=  -.369939555349859;    wt( 49)=   .022713535850235
	pos( 50)=  -.347117728597636;    wt( 50)=   .022927844143688
	pos( 51)=  -.324088435024413;    wt( 51)=   .023128448824387
	pos( 52)=  -.300865438877677;    wt( 52)=   .023315229994063
	pos( 53)=  -.277462620177904;    wt( 53)=   .023488076016536
	pos( 54)=  -.253893966422694;    wt( 54)=   .023646883584448
	pos( 55)=  -.230173564226660;    wt( 55)=   .023791557781003
	pos( 56)=  -.206315590902079;    wt( 56)=   .023922012136704
	pos( 57)=  -.182334305985337;    wt( 57)=   .024038168681024
	pos( 58)=  -.158244042714225;    wt( 58)=   .024139957989019
	pos( 59)=  -.134059199461188;    wt( 59)=   .024227319222816
	pos( 60)=  -.109794231127643;    wt( 60)=   .024300200167972
	pos( 61)=  -.085463640504515;    wt( 61)=   .024358557264690
	pos( 62)=  -.061081969604139;    wt( 62)=   .024402355633849
	pos( 63)=  -.036663790968733;    wt( 63)=   .024431569097850
	pos( 64)=  -.012223698960616;    wt( 64)=   .024446180196261
	pos( 65)=   .012223698960616;    wt( 65)=   .024446180196263
	pos( 66)=   .036663790968734;    wt( 66)=   .024431569097849
	pos( 67)=   .061081969604140;    wt( 67)=   .024402355633850
	pos( 68)=   .085463640504516;    wt( 68)=   .024358557264692
	pos( 69)=   .109794231127644;    wt( 69)=   .024300200167971
	pos( 70)=   .134059199461188;    wt( 70)=   .024227319222816
	pos( 71)=   .158244042714225;    wt( 71)=   .024139957989019
	pos( 72)=   .182334305985337;    wt( 72)=   .024038168681024
	pos( 73)=   .206315590902079;    wt( 73)=   .023922012136703
	pos( 74)=   .230173564226660;    wt( 74)=   .023791557781003
	pos( 75)=   .253893966422694;    wt( 75)=   .023646883584448
	pos( 76)=   .277462620177904;    wt( 76)=   .023488076016536
	pos( 77)=   .300865438877677;    wt( 77)=   .023315229994063
	pos( 78)=   .324088435024414;    wt( 78)=   .023128448824387
	pos( 79)=   .347117728597636;    wt( 79)=   .022927844143687
	pos( 80)=   .369939555349859;    wt( 80)=   .022713535850236
	pos( 81)=   .392540275033268;    wt( 81)=   .022485652032746
	pos( 82)=   .414906379552275;    wt( 82)=   .022244328893799
	pos( 83)=   .437024501037104;    wt( 83)=   .021989710668461
	pos( 84)=   .458881419833552;    wt( 84)=   .021721949538052
	pos( 85)=   .480464072404172;    wt( 85)=   .021441205539208
	pos( 86)=   .501759559136144;    wt( 86)=   .021147646468223
	pos( 87)=   .522755152051176;    wt( 87)=   .020841447780751
	pos( 88)=   .543438302412810;    wt( 88)=   .020522792486962
	pos( 89)=   .563796648226618;    wt( 89)=   .020191871042131
	pos( 90)=   .583818021628763;    wt( 90)=   .019848881232830
	pos( 91)=   .603490456158548;    wt( 91)=   .019494028058707
	pos( 92)=   .622802193910585;    wt( 92)=   .019127523609950
	pos( 93)=   .641741692562307;    wt( 93)=   .018749586940545
	pos( 94)=   .660297632272646;    wt( 94)=   .018360443937330
	pos( 95)=   .678458922447719;    wt( 95)=   .017960327185009
	pos( 96)=   .696214708369514;    wt( 96)=   .017549475827118
	pos( 97)=   .713554377683587;    wt( 97)=   .017128135423111
	pos( 98)=   .730467566741908;    wt( 98)=   .016696557801589
	pos( 99)=   .746944166797062;    wt( 99)=   .016255000909785
	pos(100)=   .762974330044094;    wt(100)=   .015803728659399
	pos(101)=   .778548475506412;    wt(101)=   .015343010768867
	pos(102)=   .793657294762193;    wt(102)=   .014873122602146
	pos(103)=   .808291757507914;    wt(103)=   .014394345004167
	pos(104)=   .822443116955644;    wt(104)=   .013906964132951
	pos(105)=   .836102915060907;    wt(105)=   .013411271288616
	pos(106)=   .849262987577969;    wt(106)=   .012907562739268
	pos(107)=   .861915468939549;    wt(107)=   .012396139543951
	pos(108)=   .874052796958032;    wt(108)=   .011877307372740
	pos(109)=   .885667717345397;    wt(109)=   .011351376324080
	pos(110)=   .896753288049158;    wt(110)=   .010818660739504
	pos(111)=   .907302883401757;    wt(111)=   .010279479015832
	pos(112)=   .917310198080960;    wt(112)=   .009734153415007
	pos(113)=   .926769250878948;    wt(113)=   .009183009871662
	pos(114)=   .935674388277916;    wt(114)=   .008626377798617
	pos(115)=   .944020287830220;    wt(115)=   .008064589890486
	pos(116)=   .951801961341264;    wt(116)=   .007497981925634
	pos(117)=   .959014757853700;    wt(117)=   .006926892566899
	pos(118)=   .965654366431965;    wt(118)=   .006351663161707
	pos(119)=   .971716818747137;    wt(119)=   .005772637542865
	pos(120)=   .977198491463907;    wt(120)=   .005190161832677
	pos(121)=   .982096108435719;    wt(121)=   .004604584256702
	pos(122)=   .986406742724586;    wt(122)=   .004016254983739
	pos(123)=   .990127818491734;    wt(123)=   .003425526040910
	pos(124)=   .993257112900213;    wt(124)=   .002832751471459
	pos(125)=   .995792758534981;    wt(125)=   .002238288430962
	pos(126)=   .997733248625514;    wt(126)=   .001642503018669
	pos(127)=   .999077459977376;    wt(127)=   .001045812679341
	pos(128)=   .999824887947132;    wt(128)=   .000449380960292

	case (300)

	pos(  1)=  -.999967978218437;    wt(  1)=   .000082177793687
	pos(  2)=  -.999831282984419;    wt(  2)=   .000191285544657
	pos(  3)=  -.999585373448887;    wt(  3)=   .000300533965408
	pos(  4)=  -.999230221863273;    wt(  4)=   .000409763573406
	pos(  5)=  -.998765860353094;    wt(  5)=   .000518951213458
	pos(  6)=  -.998192338073444;    wt(  6)=   .000628082977971
	pos(  7)=  -.997509717175880;    wt(  7)=   .000737146415906
	pos(  8)=  -.996718072051000;    wt(  8)=   .000846129429082
	pos(  9)=  -.995817489120824;    wt(  9)=   .000955020034435
	pos( 10)=  -.994808066763003;    wt( 10)=   .001063806298046
	pos( 11)=  -.993689915274268;    wt( 11)=   .001172476313705
	pos( 12)=  -.992463156847101;    wt( 12)=   .001281018195427
	pos( 13)=  -.991127925550990;    wt( 13)=   .001389420074992
	pos( 14)=  -.989684367315010;    wt( 14)=   .001497670101467
	pos( 15)=  -.988132639910361;    wt( 15)=   .001605756441644
	pos( 16)=  -.986472912932261;    wt( 16)=   .001713667280855
	pos( 17)=  -.984705367780896;    wt( 17)=   .001821390824019
	pos( 18)=  -.982830197641273;    wt( 18)=   .001928915296768
	pos( 19)=  -.980847607461901;    wt( 19)=   .002036228946666
	pos( 20)=  -.978757813932259;    wt( 20)=   .002143320044421
	pos( 21)=  -.976561045459023;    wt( 21)=   .002250176885139
	pos( 22)=  -.974257542141038;    wt( 22)=   .002356787789582
	pos( 23)=  -.971847555743035;    wt( 23)=   .002463141105432
	pos( 24)=  -.969331349668082;    wt( 24)=   .002569225208541
	pos( 25)=  -.966709198928774;    wt( 25)=   .002675028504213
	pos( 26)=  -.963981390117157;    wt( 26)=   .002780539428451
	pos( 27)=  -.961148221373393;    wt( 27)=   .002885746449232
	pos( 28)=  -.958210002353166;    wt( 28)=   .002990638067745
	pos( 29)=  -.955167054193829;    wt( 29)=   .003095202819667
	pos( 30)=  -.952019709479304;    wt( 30)=   .003199429276402
	pos( 31)=  -.948768312203718;    wt( 31)=   .003303306046332
	pos( 32)=  -.945413217733814;    wt( 32)=   .003406821776056
	pos( 33)=  -.941954792770098;    wt( 33)=   .003509965151654
	pos( 34)=  -.938393415306765;    wt( 34)=   .003612724899877
	pos( 35)=  -.934729474590380;    wt( 35)=   .003715089789432
	pos( 36)=  -.930963371077334;    wt( 36)=   .003817048632170
	pos( 37)=  -.927095516390074;    wt( 37)=   .003918590284326
	pos( 38)=  -.923126333272116;    wt( 38)=   .004019703647736
	pos( 39)=  -.919056255541836;    wt( 39)=   .004120377671043
	pos( 40)=  -.914885728045058;    wt( 40)=   .004220601350909
	pos( 41)=  -.910615206606430;    wt( 41)=   .004320363733223
	pos( 42)=  -.906245157979603;    wt( 42)=   .004419653914286
	pos( 43)=  -.901776059796224;    wt( 43)=   .004518461042013
	pos( 44)=  -.897208400513720;    wt( 44)=   .004616774317115
	pos( 45)=  -.892542679361921;    wt( 45)=   .004714582994278
	pos( 46)=  -.887779406288490;    wt( 46)=   .004811876383341
	pos( 47)=  -.882919101903191;    wt( 47)=   .004908643850461
	pos( 48)=  -.877962297420986;    wt( 48)=   .005004874819280
	pos( 49)=  -.872909534603972;    wt( 49)=   .005100558772072
	pos( 50)=  -.867761365702173;    wt( 50)=   .005195685250902
	pos( 51)=  -.862518353393181;    wt( 51)=   .005290243858763
	pos( 52)=  -.857181070720652;    wt( 52)=   .005384224260718
	pos( 53)=  -.851750101031677;    wt( 53)=   .005477616185022
	pos( 54)=  -.846226037913027;    wt( 54)=   .005570409424251
	pos( 55)=  -.840609485126269;    wt( 55)=   .005662593836414
	pos( 56)=  -.834901056541787;    wt( 56)=   .005754159346065
	pos( 57)=  -.829101376071675;    wt( 57)=   .005845095945400
	pos( 58)=  -.823211077601558;    wt( 58)=   .005935393695352
	pos( 59)=  -.817230804921301;    wt( 59)=   .006025042726680
	pos( 60)=  -.811161211654653;    wt( 60)=   .006114033241044
	pos( 61)=  -.805002961187798;    wt( 61)=   .006202355512084
	pos( 62)=  -.798756726596861;    wt( 62)=   .006289999886465
	pos( 63)=  -.792423190574332;    wt( 63)=   .006376956784956
	pos( 64)=  -.786003045354459;    wt( 64)=   .006463216703457
	pos( 65)=  -.779496992637581;    wt( 65)=   .006548770214047
	pos( 66)=  -.772905743513440;    wt( 66)=   .006633607966017
	pos( 67)=  -.766230018383461;    wt( 67)=   .006717720686883
	pos( 68)=  -.759470546882013;    wt( 68)=   .006801099183406
	pos( 69)=  -.752628067796662;    wt( 69)=   .006883734342599
	pos( 70)=  -.745703328987423;    wt( 70)=   .006965617132712
	pos( 71)=  -.738697087305026;    wt( 71)=   .007046738604233
	pos( 72)=  -.731610108508191;    wt( 72)=   .007127089890857
	pos( 73)=  -.724443167179933;    wt( 73)=   .007206662210456
	pos( 74)=  -.717197046642905;    wt( 74)=   .007285446866045
	pos( 75)=  -.709872538873780;    wt( 75)=   .007363435246724
	pos( 76)=  -.702470444416695;    wt( 76)=   .007440618828623
	pos( 77)=  -.694991572295750;    wt( 77)=   .007516989175838
	pos( 78)=  -.687436739926587;    wt( 78)=   .007592537941344
	pos( 79)=  -.679806773027049;    wt( 79)=   .007667256867915
	pos( 80)=  -.672102505526930;    wt( 80)=   .007741137789022
	pos( 81)=  -.664324779476831;    wt( 81)=   .007814172629731
	pos( 82)=  -.656474444956127;    wt( 82)=   .007886353407574
	pos( 83)=  -.648552359980056;    wt( 83)=   .007957672233437
	pos( 84)=  -.640559390405937;    wt( 84)=   .008028121312413
	pos( 85)=  -.632496409838541;    wt( 85)=   .008097692944651
	pos( 86)=  -.624364299534605;    wt( 86)=   .008166379526207
	pos( 87)=  -.616163948306512;    wt( 87)=   .008234173549863
	pos( 88)=  -.607896252425153;    wt( 88)=   .008301067605967
	pos( 89)=  -.599562115521963;    wt( 89)=   .008367054383219
	pos( 90)=  -.591162448490156;    wt( 90)=   .008432126669484
	pos( 91)=  -.582698169385169;    wt( 91)=   .008496277352581
	pos( 92)=  -.574170203324327;    wt( 92)=   .008559499421059
	pos( 93)=  -.565579482385718;    wt( 93)=   .008621785964948
	pos( 94)=  -.556926945506335;    wt( 94)=   .008683130176552
	pos( 95)=  -.548213538379440;    wt( 95)=   .008743525351140
	pos( 96)=  -.539440213351213;    wt( 96)=   .008802964887731
	pos( 97)=  -.530607929316659;    wt( 97)=   .008861442289780
	pos( 98)=  -.521717651614803;    wt( 98)=   .008918951165905
	pos( 99)=  -.512770351923185;    wt( 99)=   .008975485230575
	pos(100)=  -.503767008151656;    wt(100)=   .009031038304809
	pos(101)=  -.494708604335499;    wt(101)=   .009085604316842
	pos(102)=  -.485596130527873;    wt(102)=   .009139177302792
	pos(103)=  -.476430582691606;    wt(103)=   .009191751407309
	pos(104)=  -.467212962590343;    wt(104)=   .009243320884221
	pos(105)=  -.457944277679048;    wt(105)=   .009293880097161
	pos(106)=  -.448625540993898;    wt(106)=   .009343423520170
	pos(107)=  -.439257771041566;    wt(107)=   .009391945738323
	pos(108)=  -.429841991687891;    wt(108)=   .009439441448302
	pos(109)=  -.420379232045981;    wt(109)=   .009485905458982
	pos(110)=  -.410870526363734;    wt(110)=   .009531332692010
	pos(111)=  -.401316913910792;    wt(111)=   .009575718182339
	pos(112)=  -.391719438864958;    wt(112)=   .009619057078780
	pos(113)=  -.382079150198071;    wt(113)=   .009661344644539
	pos(114)=  -.372397101561353;    wt(114)=   .009702576257728
	pos(115)=  -.362674351170252;    wt(115)=   .009742747411869
	pos(116)=  -.352911961688781;    wt(116)=   .009781853716390
	pos(117)=  -.343111000113372;    wt(117)=   .009819890897103
	pos(118)=  -.333272537656259;    wt(118)=   .009856854796673
	pos(119)=  -.323397649628395;    wt(119)=   .009892741375065
	pos(120)=  -.313487415321926;    wt(120)=   .009927546710002
	pos(121)=  -.303542917892229;    wt(121)=   .009961266997376
	pos(122)=  -.293565244239525;    wt(122)=   .009993898551670
	pos(123)=  -.283555484890083;    wt(123)=   .010025437806366
	pos(124)=  -.273514733877034;    wt(124)=   .010055881314331
	pos(125)=  -.263444088620791;    wt(125)=   .010085225748190
	pos(126)=  -.253344649809111;    wt(126)=   .010113467900695
	pos(127)=  -.243217521276786;    wt(127)=   .010140604685074
	pos(128)=  -.233063809885005;    wt(128)=   .010166633135365
	pos(129)=  -.222884625400372;    wt(129)=   .010191550406750
	pos(130)=  -.212681080373617;    wt(130)=   .010215353775852
	pos(131)=  -.202454290017994;    wt(131)=   .010238040641042
	pos(132)=  -.192205372087394;    wt(132)=   .010259608522725
	pos(133)=  -.181935446754176;    wt(133)=   .010280055063600
	pos(134)=  -.171645636486740;    wt(134)=   .010299378028931
	pos(135)=  -.161337065926842;    wt(135)=   .010317575306780
	pos(136)=  -.151010861766675;    wt(136)=   .010334644908249
	pos(137)=  -.140668152625726;    wt(137)=   .010350584967686
	pos(138)=  -.130310068927418;    wt(138)=   .010365393742897
	pos(139)=  -.119937742775566;    wt(139)=   .010379069615331
	pos(140)=  -.109552307830634;    wt(140)=   .010391611090262
	pos(141)=  -.099154899185835;    wt(141)=   .010403016796949
	pos(142)=  -.088746653243067;    wt(142)=   .010413285488786
	pos(143)=  -.078328707588707;    wt(143)=   .010422416043440
	pos(144)=  -.067902200869279;    wt(144)=   .010430407462970
	pos(145)=  -.057468272667004;    wt(145)=   .010437258873943
	pos(146)=  -.047028063375243;    wt(146)=   .010442969527522
	pos(147)=  -.036582714073862;    wt(147)=   .010447538799552
	pos(148)=  -.026133366404511;    wt(148)=   .010450966190626
	pos(149)=  -.015681162445849;    wt(149)=   .010453251326143
	pos(150)=  -.005227244588718;    wt(150)=   .010454393956345
	pos(151)=   .005227244588718;    wt(151)=   .010454393956344
	pos(152)=   .015681162445849;    wt(152)=   .010453251326143
	pos(153)=   .026133366404511;    wt(153)=   .010450966190627
	pos(154)=   .036582714073862;    wt(154)=   .010447538799552
	pos(155)=   .047028063375243;    wt(155)=   .010442969527523
	pos(156)=   .057468272667004;    wt(156)=   .010437258873943
	pos(157)=   .067902200869280;    wt(157)=   .010430407462970
	pos(158)=   .078328707588708;    wt(158)=   .010422416043439
	pos(159)=   .088746653243068;    wt(159)=   .010413285488785
	pos(160)=   .099154899185836;    wt(160)=   .010403016796949
	pos(161)=   .109552307830635;    wt(161)=   .010391611090262
	pos(162)=   .119937742775567;    wt(162)=   .010379069615331
	pos(163)=   .130310068927419;    wt(163)=   .010365393742897
	pos(164)=   .140668152625726;    wt(164)=   .010350584967687
	pos(165)=   .151010861766676;    wt(165)=   .010334644908250
	pos(166)=   .161337065926843;    wt(166)=   .010317575306779
	pos(167)=   .171645636486741;    wt(167)=   .010299378028931
	pos(168)=   .181935446754176;    wt(168)=   .010280055063601
	pos(169)=   .192205372087393;    wt(169)=   .010259608522724
	pos(170)=   .202454290017995;    wt(170)=   .010238040641043
	pos(171)=   .212681080373618;    wt(171)=   .010215353775852
	pos(172)=   .222884625400373;    wt(172)=   .010191550406752
	pos(173)=   .233063809885005;    wt(173)=   .010166633135367
	pos(174)=   .243217521276786;    wt(174)=   .010140604685073
	pos(175)=   .253344649809111;    wt(175)=   .010113467900696
	pos(176)=   .263444088620791;    wt(176)=   .010085225748190
	pos(177)=   .273514733877034;    wt(177)=   .010055881314331
	pos(178)=   .283555484890083;    wt(178)=   .010025437806366
	pos(179)=   .293565244239525;    wt(179)=   .009993898551670
	pos(180)=   .303542917892229;    wt(180)=   .009961266997375
	pos(181)=   .313487415321926;    wt(181)=   .009927546710002
	pos(182)=   .323397649628395;    wt(182)=   .009892741375065
	pos(183)=   .333272537656259;    wt(183)=   .009856854796671
	pos(184)=   .343111000113372;    wt(184)=   .009819890897104
	pos(185)=   .352911961688780;    wt(185)=   .009781853716390
	pos(186)=   .362674351170252;    wt(186)=   .009742747411869
	pos(187)=   .372397101561353;    wt(187)=   .009702576257729
	pos(188)=   .382079150198070;    wt(188)=   .009661344644539
	pos(189)=   .391719438864958;    wt(189)=   .009619057078779
	pos(190)=   .401316913910791;    wt(190)=   .009575718182338
	pos(191)=   .410870526363734;    wt(191)=   .009531332692010
	pos(192)=   .420379232045982;    wt(192)=   .009485905458984
	pos(193)=   .429841991687891;    wt(193)=   .009439441448301
	pos(194)=   .439257771041566;    wt(194)=   .009391945738323
	pos(195)=   .448625540993898;    wt(195)=   .009343423520170
	pos(196)=   .457944277679047;    wt(196)=   .009293880097161
	pos(197)=   .467212962590342;    wt(197)=   .009243320884223
	pos(198)=   .476430582691606;    wt(198)=   .009191751407308
	pos(199)=   .485596130527872;    wt(199)=   .009139177302790
	pos(200)=   .494708604335498;    wt(200)=   .009085604316842
	pos(201)=   .503767008151656;    wt(201)=   .009031038304810
	pos(202)=   .512770351923184;    wt(202)=   .008975485230577
	pos(203)=   .521717651614803;    wt(203)=   .008918951165905
	pos(204)=   .530607929316659;    wt(204)=   .008861442289781
	pos(205)=   .539440213351214;    wt(205)=   .008802964887732
	pos(206)=   .548213538379441;    wt(206)=   .008743525351142
	pos(207)=   .556926945506335;    wt(207)=   .008683130176551
	pos(208)=   .565579482385720;    wt(208)=   .008621785964950
	pos(209)=   .574170203324328;    wt(209)=   .008559499421056
	pos(210)=   .582698169385171;    wt(210)=   .008496277352583
	pos(211)=   .591162448490156;    wt(211)=   .008432126669484
	pos(212)=   .599562115521964;    wt(212)=   .008367054383218
	pos(213)=   .607896252425154;    wt(213)=   .008301067605966
	pos(214)=   .616163948306512;    wt(214)=   .008234173549863
	pos(215)=   .624364299534604;    wt(215)=   .008166379526206
	pos(216)=   .632496409838540;    wt(216)=   .008097692944651
	pos(217)=   .640559390405937;    wt(217)=   .008028121312412
	pos(218)=   .648552359980056;    wt(218)=   .007957672233438
	pos(219)=   .656474444956128;    wt(219)=   .007886353407574
	pos(220)=   .664324779476831;    wt(220)=   .007814172629730
	pos(221)=   .672102505526930;    wt(221)=   .007741137789023
	pos(222)=   .679806773027048;    wt(222)=   .007667256867915
	pos(223)=   .687436739926587;    wt(223)=   .007592537941343
	pos(224)=   .694991572295750;    wt(224)=   .007516989175838
	pos(225)=   .702470444416696;    wt(225)=   .007440618828623
	pos(226)=   .709872538873781;    wt(226)=   .007363435246724
	pos(227)=   .717197046642905;    wt(227)=   .007285446866046
	pos(228)=   .724443167179934;    wt(228)=   .007206662210457
	pos(229)=   .731610108508191;    wt(229)=   .007127089890857
	pos(230)=   .738697087305026;    wt(230)=   .007046738604234
	pos(231)=   .745703328987423;    wt(231)=   .006965617132711
	pos(232)=   .752628067796661;    wt(232)=   .006883734342599
	pos(233)=   .759470546882013;    wt(233)=   .006801099183407
	pos(234)=   .766230018383461;    wt(234)=   .006717720686883
	pos(235)=   .772905743513439;    wt(235)=   .006633607966018
	pos(236)=   .779496992637580;    wt(236)=   .006548770214048
	pos(237)=   .786003045354458;    wt(237)=   .006463216703457
	pos(238)=   .792423190574332;    wt(238)=   .006376956784955
	pos(239)=   .798756726596861;    wt(239)=   .006289999886464
	pos(240)=   .805002961187798;    wt(240)=   .006202355512083
	pos(241)=   .811161211654653;    wt(241)=   .006114033241045
	pos(242)=   .817230804921301;    wt(242)=   .006025042726678
	pos(243)=   .823211077601557;    wt(243)=   .005935393695351
	pos(244)=   .829101376071674;    wt(244)=   .005845095945399
	pos(245)=   .834901056541786;    wt(245)=   .005754159346065
	pos(246)=   .840609485126269;    wt(246)=   .005662593836414
	pos(247)=   .846226037913026;    wt(247)=   .005570409424250
	pos(248)=   .851750101031677;    wt(248)=   .005477616185022
	pos(249)=   .857181070720652;    wt(249)=   .005384224260718
	pos(250)=   .862518353393182;    wt(250)=   .005290243858763
	pos(251)=   .867761365702174;    wt(251)=   .005195685250901
	pos(252)=   .872909534603972;    wt(252)=   .005100558772072
	pos(253)=   .877962297420986;    wt(253)=   .005004874819280
	pos(254)=   .882919101903192;    wt(254)=   .004908643850461
	pos(255)=   .887779406288490;    wt(255)=   .004811876383341
	pos(256)=   .892542679361921;    wt(256)=   .004714582994277
	pos(257)=   .897208400513720;    wt(257)=   .004616774317116
	pos(258)=   .901776059796223;    wt(258)=   .004518461042013
	pos(259)=   .906245157979603;    wt(259)=   .004419653914286
	pos(260)=   .910615206606429;    wt(260)=   .004320363733223
	pos(261)=   .914885728045059;    wt(261)=   .004220601350909
	pos(262)=   .919056255541837;    wt(262)=   .004120377671042
	pos(263)=   .923126333272116;    wt(263)=   .004019703647735
	pos(264)=   .927095516390074;    wt(264)=   .003918590284326
	pos(265)=   .930963371077333;    wt(265)=   .003817048632171
	pos(266)=   .934729474590380;    wt(266)=   .003715089789432
	pos(267)=   .938393415306765;    wt(267)=   .003612724899878
	pos(268)=   .941954792770098;    wt(268)=   .003509965151651
	pos(269)=   .945413217733814;    wt(269)=   .003406821776058
	pos(270)=   .948768312203718;    wt(270)=   .003303306046330
	pos(271)=   .952019709479303;    wt(271)=   .003199429276402
	pos(272)=   .955167054193829;    wt(272)=   .003095202819668
	pos(273)=   .958210002353164;    wt(273)=   .002990638067745
	pos(274)=   .961148221373392;    wt(274)=   .002885746449232
	pos(275)=   .963981390117156;    wt(275)=   .002780539428452
	pos(276)=   .966709198928773;    wt(276)=   .002675028504212
	pos(277)=   .969331349668081;    wt(277)=   .002569225208542
	pos(278)=   .971847555743034;    wt(278)=   .002463141105432
	pos(279)=   .974257542141037;    wt(279)=   .002356787789584
	pos(280)=   .976561045459023;    wt(280)=   .002250176885139
	pos(281)=   .978757813932259;    wt(281)=   .002143320044420
	pos(282)=   .980847607461900;    wt(282)=   .002036228946666
	pos(283)=   .982830197641273;    wt(283)=   .001928915296768
	pos(284)=   .984705367780896;    wt(284)=   .001821390824018
	pos(285)=   .986472912932260;    wt(285)=   .001713667280856
	pos(286)=   .988132639910361;    wt(286)=   .001605756441643
	pos(287)=   .989684367315010;    wt(287)=   .001497670101467
	pos(288)=   .991127925550990;    wt(288)=   .001389420074991
	pos(289)=   .992463156847101;    wt(289)=   .001281018195428
	pos(290)=   .993689915274268;    wt(290)=   .001172476313705
	pos(291)=   .994808066763003;    wt(291)=   .001063806298047
	pos(292)=   .995817489120825;    wt(292)=   .000955020034434
	pos(293)=   .996718072051000;    wt(293)=   .000846129429081
	pos(294)=   .997509717175880;    wt(294)=   .000737146415906
	pos(295)=   .998192338073444;    wt(295)=   .000628082977972
	pos(296)=   .998765860353095;    wt(296)=   .000518951213460
	pos(297)=   .999230221863274;    wt(297)=   .000409763573404
	pos(298)=   .999585373448887;    wt(298)=   .000300533965408
	pos(299)=   .999831282984419;    wt(299)=   .000191285544658
	pos(300)=   .999967978218437;    wt(300)=   .000082177793688

	end select

END SUBROUTINE quadrature
!**************************************************************
!	Gauss1:
!		Gauss elimination method to sovle linear equations.
!
!	Inputs:
!		Num: size of matrix
!		LeftMatrix: left-hand side of matrix
!		RightMatrix: right-hand side of matrix
!**************************************************************
SUBROUTINE GAUSS1(NUM,LeftMatrix,RightMatrix)
	use ZQMPI
	implicit none
	
	INTEGER::NUM
	DOUBLE PRECISION,DIMENSION(NUM,NUM)::Left,LeftMatrix
	DOUBLE PRECISION,DIMENSION(NUM)::RIGHT,COEFF,RightMatrix
	INTEGER,DIMENSION(NUM)::KEE_COL
		
	Intent(in)::LeftMatrix

	INTEGER::I,J,K,L,KK,LL
	DOUBLE PRECISION::INTER_UU  
	INTEGER::SIGN_OF_CHANGE

	!//////////////////////////////////////////////////////////////////
	!	Pay attention to the dimension of the variables: they must be the
	!	same as those of the variable transfered in the main program.
	!	If they are not the same, the transfer will not be carried out 
	!	correctly.
	!//////////////////////////////////////////////////////////////////

	!//////////////////////////////////////////////////////////////////
	!	TRANSFER THE DATE
	DO I=1,NUM
		RIGHT(I)=RightMatrix(I)
		DO J=1,NUM
			Left(I,J)=LeftMatrix(I,J)
		END DO
	END DO
	
	!/////////////////////////////////////////////////////////////////
	!	ARRANGE THE MATRIX
	DO I=1,NUM-1
		!....FIND THE LARGEST COEFFICIENT....
		INTER_UU=Left(I,I)
		KK=I
		LL=I
		DO K=I,NUM
			DO L=I,NUM    
				IF(ABS(INTER_UU)<ABS(Left(K,L)))THEN
					INTER_UU=Left(K,L)
					KK=K
					LL=L
				END IF
			END DO
		END DO
		KEE_COL(I)=LL 

		!....CHANGE THE LINE AND COLLUM....
		DO K=I,NUM   !LINE
			INTER_UU=Left(KK,K)
			Left(KK,K)=Left(I,K)
			Left(I,K)=INTER_UU
		END DO
  
		INTER_UU=RIGHT(I)   !RIGHT
		RIGHT(I)=RIGHT(KK)
		RIGHT(KK)=INTER_UU
   
		DO J=I,NUM  !COLLUM
			INTER_UU=Left(J,LL)
			Left(J,LL)=Left(J,I)
			Left(J,I)=INTER_UU
		END DO
   
         
		!....USE GAUSS'S METHOD....
		DO J=I+1,NUM
			RIGHT(J)=RIGHT(J)-RIGHT(I)*Left(J,I)/Left(I,I)
			DO K=I+1,NUM
				Left(J,K)=Left(J,K)-Left(I,K)*Left(J,I)/Left(I,I)
			END DO
		END DO
	END DO       
	
	!//////////////////////////////////////////////////////////////
	!	GO BACK TO GET THE VALUE
	!
	!	PAY ATTENTION TO HERE: THE STEP LEGTH OF EACH 
	!	LOOP IS ASSUMED TO BE 1 IF YOU DON'T DECLARE IT.
	!	BUT IF YOU WANT TO DO LOOP FROM A LARGE NUMBER 
	!	TO A SMALL NUMBER, YOU MUST DECLARE THE STEP 
	!	LENGTH TO BE A NEGTIVE INTEGER. IN OTHER CASES 
	!	THAT THE STEP LEGTH IS NOT 1, YOU ALSO NEED DO SO.
	
	DO I=NUM,1,-1
	   IF(I==NUM)THEN
			 COEFF(I)=RIGHT(I)/Left(I,I)
	   END IF
	   IF(I/=NUM)THEN
			COEFF(I)=RIGHT(I)/Left(I,I)
			DO J=I+1,NUM
			   COEFF(I)=COEFF(I)-Left(I,J)/Left(I,I)*COEFF(J)
			END DO
			INTER_UU=COEFF(KEE_COL(I))
			COEFF(KEE_COL(I))=COEFF(I)
			COEFF(I)=INTER_UU
	   END IF
	END DO

	!////////////////////////////////////////////////////////
	!	Get the result
	DO I=1,NUM
	   RightMatrix(I)=COEFF(I)
	ENDDO

END SUBROUTINE GAUSS1

!***********************************************************************
! SurfLoop:                                                            *
!       Pass a subroutine to SurfLoop to call this subroutine              *
!       over loop by loop.                                                 *
!                                                                          *
!       IF a subroutine is declared with key word "external", then,        *
!       it could be transferred as an actual parameter.                    *
!                                                                          *
!       3 cases to begin surf according to the type of dislocation points: *
!       1). it is a intersection point and not surfed.                     *
!       2). it is a fixed point, not surfed and the first one on           *
!               the loop.                                                      *
!       3). It is a point on a closed loop.                                *
!
!       Modified: ZQ Wang:
!       May 8 2006
!       New conditions to begin surf a loop:
!               1). It is a fixed point, either with front connection point or not,
!                  it is considered as the beginning point for a loop;
!               2). It is a point with no front connection point, so it is the first
!                  point for a loop;
!               3). It is a point on a closed loop.
!        5/19/06:
!          if iEndP==-1, it can not be the first point. Modified.
!          Temporarily consider the closed loop.
!***********************************************************************
subroutine SurfLoop(sub)
        use ZQMPI
        use vectors
        use variables,only:iNPoint,DPoints,iDPTypefixed,iDPtypeFree
	use SurfMD,only: iSurfCounter
        implicit none

        external sub
        integer::i,j

        j=iNPoint
        !initialize status
        do i=1,iNPOint
                DPoints(i)%lStat=.false.
        enddo

        !begin surfing
        !fixed point, beginning points
        do while(.true.)
                do i=1,iNPoint
                        if( .not. DPoints(i)%lStat .and. DPoints(i)%iEndP/=-1 .and.                       &
                                (DPoints(i)%iBeginP==-1))then
				iSurfCounter=0
                                 call sub(i)
                        endif
                enddo
                if(iNpoint/=j)then
                        j=iNPoint
                else
                        exit
                endif
        enddo
        !free points, left from above surfings, on closed loops
        do i=1,iNPoint
                if( .not. DPOints(i)%lStat .and. DPoints(i)%iEndP/=-1)then
			iSurfCounter=0
                        call sub(i)
                endif
        enddo

end subroutine SurfLoop
!****************************************************************************
!	GetDisSq:																*
!		Get the square of the distance in periodic condition.               *
!****************************************************************************
double precision function GetDistSq(a,b)
	use ZQMPI
	USE VECTORS
	USE VARIABLES,only:A_CUBE
	IMPLICIT NONE
	type(vector), intent(IN)		:: a,b
	double precision	:: x, y, z, tmp

	tmp = A_Cube*0.5d0

	x = abs(a%V(1) - b%V(1))
	y = abs(a%V(2) - b%V(2))
	z = abs(a%V(3) - b%V(3))

	if (x > tmp) then
		x = x - A_Cube
	end	if
  
	if (y > tmp) then
		y = y - A_Cube
	end	if
  
	if (z > tmp) then
		z = z - A_Cube
	end	if
  
	GetDistSq = x*x + y*y + z*z

end function GetDistSq
!*************************************************************************
!	GetDist:                                                             *
!		Get the distance of two points with periodic boundary condition  *
!*************************************************************************
double precision function GetDist(a,b)
	use ZQMPI
	USE VECTORS
	IMPLICIT NONE
	double precision GetDistSq
	type(vector), intent(IN)		:: a,b
	
	GetDist = dsqrt(GetDistSq(a,b))

end function GetDist
!*****************************************************************
!	lSameLoopSeg:                                                *
!		Check if two segments are on same loop.                  *
!*****************************************************************
logical function lSameLoopSeg(i,j)
	use ZQMPI
	use vectors
	use variables,only:DPoints
	implicit none
	
	integer,intent(in)::i,j
	lSameLoopSeg=.false.
	if(DPoints(i)%iLoopID==DPoints(j)%iLoopID)then
		lSameLoopSeg=.true.
	endif

end function lSameLoopSeg
!********************************************************************
!	lConnectedSeg: Updated 10/21/2005 by ZQ Wang: conditions corredted                                                 *
!		check if two segments are connected together.               *
!********************************************************************
logical function lConnectedSeg(i,j)
	use ZQMPI
	use vectors
	use variables,only:DPoints
	implicit none

	integer,intent(in)::i,j

	lConnectedSeg=.false.

	! connected seg conditions:
	!	if the beginning of the one is the end of another one
	if(DPoints(i)%iEndP==j .or. DPoints(i)%iBeginP==j .or. &
		DPoints(j)%iEndP==i .or. DPoints(j)%iBeginP==i)then
			lConnectedSeg=.true.
	endif
end function lConnectedSeg
!********************************************************************
!	lHaveSameBur:                                                   *
!		check if two segments have the same burgers vector.         *
!********************************************************************
logical function lHaveSameBur(i,j)
	use ZQMPI
	use vectors
	use variables,only:DPoints
	implicit none

	integer,intent(in)::i,j

	lHaveSameBur=.false.
	if(DPoints(i)%iBurgers==DPoints(j)%iBurgers)then
		lHaveSameBur=.true.
	endif
end function lHaveSameBur
!**********************************************************************
!	GetTangent:                                                       *
!		Given number of points, the position of points, to calculate  *
!	tangent vectors at each point                                     *
!
!		iNumNode>=3
!**********************************************************************
subroutine getTangent(iNumNode,tvTmpPL,tvTmpTL,itmpLooptype)
	use ZQMPI
	use vectors
	use variables,only:DPOints,iNPoint
	implicit none

	integer,intent(in)::iNumNode,itmpLooptype
	type(vector),dimension(iNumNode)::tvTmpPL,tvTmpTL
	integer::iNum,i,j,k,iIndex,state
	integer,dimension(3)::iCoe
	double precision,allocatable,dimension(:,:)::dpaLeft
	double precision,allocatable,dimension(:)::dpaRight
	
	if(iNumNode<=2)return   !if number of nodes is 2, just leave it there.

	if(itmpLooptype==1)then
		iNum=iNumNode-2
	else
		iNum=iNumNode
	endif

	allocate(dpaLeft(iNum,iNum),dpaRight(iNum))
	
	iCoe(1)=1
	iCoe(2)=4
	iCoe(3)=1

	do iIndex=1,2
		!...Left matrix....
		do i=1,iNum
			do j=1,iNum
				dpaLeft(i,j)=0.d0
			enddo

			k=i-1
			do j=1,3
				if(k>=1 .and. k<=iNum)then
					dpaLeft(i,k)=iCoe(j)
				endif
				k=k+1
			enddo

			if(itmpLooptype==0)then
				if(i==1)then
					dpaLeft(i,iNum)=iCoe(1)
				else if(i==iNum)then
					dpaLeft(i,1)=iCoe(3)
				endif
				
			endif
		enddo

		!...Right matrix....
		do i=1,iNum
			if(itmplooptype==0)then
				if(i==1)then
					dpaRight(i)=3*(tvTmpPL(2)%v(iIndex)-tvTmpPL(iNum)%v(iIndex))
				elseif(i==iNum)then
					dpaRight(i)=3*(tvTmpPL(1)%v(iIndex)-tvTmpPL(iNum-1)%v(iIndex))
				else
					dpaRight(i)=3*(tvTmpPL(i+1)%v(iIndex)-tvTmpPL(i-1)%v(iIndex))
				endif
			else
				dpaRight(i)=3*(tvTmpPL(i+2)%v(iIndex)-tvTmpPL(i)%v(iIndex))
				!here they should be 
				if(i==1)then
					dpaRight(i)=dpaRight(i)-tvTmpTL(1)%v(iIndex)
				endif
				if(i==iNum)then
					dpaRight(i)=dpaRight(i)-tvTmpTL(i+2)%v(iIndex)
				endif
			endif
		enddo	

		!...Solve the equations
		call Gauss1(iNum,dpaLeft,dpaRight)

		!...Assign....
		if(itmpLooptype==1)then
			do i=1,iNum
				tvtmpTL(i+1)%v(iIndex)=dpaRight(i)
			enddo
		else
			do i=1,iNum
				tvtmpTL(i)%v(iIndex)=dpaRight(i)
			enddo
		endif

	enddo

	deallocate(dpaLeft,dpaRight,STAT=state)
end subroutine getTangent
!********************************************************************
!	SetGlobal:														*
!		Return the global position of a point with input PL,TL.		*
!		The glide plane is also changed.                            *
!																	*
!		1. The local plane and local position on this plane is know.*
!		2. No connection vector or plane is needed.					*
!		3. New glide plane global needs to be computed.				*
!																	*
!		Steps:														*
!			1.calculate the new PG,TG based on local points			*
!			2.check if it is in the cube.							*
!			3.apply PBC based on the result of 2.					*
!			4.if intersection point, find new for second plane      *
!			  based on the global position.							*
!                                                                   *
!		Local->global->Local                                        *
!********************************************************************
subroutine SetGlobal(PointID)
	use ZQMPI
	use vectors
	use variables,only:DPoints,GPlanes,Miller,A_Cube,iNPlane,MAX_PLANE,iloop
	use MPIModule,only:iNTotalGPs
	implicit none

	integer,intent(in)::PointID
	type(vector)::PL,TL
	type(vector)::PG,TG,PLL,TLL
	type(vector)::Origin

	integer::I,j,k
	integer::i_P,i_m,i_p1
	logical::lFlag

	PL=DPoints(PointID)%tvPL
	TL=DPoints(PointID)%tvTL
	i_p=DPoints(PointID)%iPlane
	i_m=GPlanes(i_p)%iMiller
	
	PG=TRANS(Miller(i_m)%ES)*PL+GPlanes(i_p)%Origin
	TG=TRANS(Miller(i_m)%ES)*TL

	!new global position 1
	do i=1,3
		if(PG%v(i)<0.d0)then
			PG%v(i)=Mod(PG%v(i),A_Cube)+A_Cube
		else
			PG%v(i)=Mod(PG%v(i),A_Cube)
		endif
	enddo

	DPoints(PointID)%tvPG=PG
	DPoints(PointID)%tvTG=TG

	!local position in new system
	PLL=Miller(i_m)%ES*(PG-GPlanes(i_p)%Origin) !
	PLL%v(3)=0.d0
	DPoints(PointID)%tvPL=PLL
	DPoints(PointID)%tvTL=TL

	!origin of glide plane
	PLL=Trans(Miller(i_m)%ES)*PLL  !back to global
	Origin=PG-PLL
	i_p1=DPoints(PointID)%iPlane
	
	call checkPlanes(Origin,i_p,i_p1,i_m)

	DPoints(PointID)%iPlane=i_p

end subroutine SetGlobal
!*********************************************************************
!	CheckPlanes:
!		Origin:	new origin
!		i_p:	new ID of the plane, maybe the same as i_p1, original plane
!		i_p1:	ID of the origianl plane
!		i_m:	miller index
!*********************************************************************
subroutine CheckPlanes(Origin,i_p,i_p1,i_m)
	use ZQMPI
	use vectors
	use variables,only:GPlanes,Miller,iNPlane,MAX_Plane
	implicit none

	type(vector)::Origin
	integer::i_p,i_p1,i_m
	logical::lFlag
	integer::i,j,k
	logical::lInEquivPList

	if(dabs((Origin-GPlanes(i_p1)%Origin)*UV(Miller(i_m)%v))<1.d0)then
		!same plane, plane number does not change.
		i_p=i_p1
	else
		!different plane
		lFlag=.false.
		do i=1,iNPlane
			if(i_m==GPlanes(i)%iMiller)then
				if(dabs((Origin-GPlanes(i)%Origin)*UV(Miller(i_m)%v))<1.d0)then
					i_p=i
					lFlag=.true.
					exit
				endif
			endif
		enddo
		if(.not. lFlag)then
			
			if(iNPlane<MAX_PLANE)then
				iNPlane=iNPlane+1
				i_p=iNPlane
				GPlanes(i_p)%Origin=Origin
				GPlanes(i_p)%iMiller=i_m
				GPlanes(i_p)%iNumPEquiv=0
			endif
		endif

		if(.not. lInEquivPList(i_p,i_p1))call AddToEquivPList(i_p,i_p1)
		if(.not. lInEquivPList(i_p1,i_p))call AddToEquivPList(i_p1,i_p)

	endif

end subroutine CheckPlanes
!**********************************************************************
!	lInEquivPList:
!		Check if two glide planes are equivalent, which means that they
!		have the same miller index.
!
!		i_p1: the plane with the list
!		i_p2: the plane in the list
!**********************************************************************
logical function lInEquivPList(i_p1,i_p2)
	use ZQMPI
	use vectors
	use variables,only:GPlanes
	implicit none

	integer::i
	integer,intent(in)::i_p1,i_p2

	lInEquivPList=.false.

	if(i_p1==i_p2)then
		lInEquivPList=.true.
		return
	endif
	do i=1,GPlanes(i_p1)%iNumPEquiv
		if(i_p2==GPlanes(i_p1)%iIDPEquiv(i))then
			lInEquivPList=.true.
			exit
		endif
	enddo

	return

end function lInEquivPList
!********************************************************************
!	AddToEquivPList:
!		i_p1: the plane with the list
!		i_p2: the plane in the list
!********************************************************************
subroutine AddToEquivPList(i_p1,i_p2)
	use ZQMPI
	use vectors
	use variables,only:GPlanes
	implicit none

	integer::i
	integer,intent(in)::i_p1,i_p2

	if(GPlanes(i_p1)%iNumPEquiv<5)then
		GPlanes(i_P1)%iNumPEquiv=GPlanes(i_p1)%iNumPEquiv+1
		GPlanes(i_p1)%iIDPEquiv(GPlanes(i_p1)%iNumPEquiv)=i_p2
	endif

end subroutine AddToEquivPList
!********************************************************************
!	getRaGlobal:
!		Return the global PG,TG according to already set connectVec
!	and connectPlane.
!		Only ConnectVec is needed.
!*******************************************************************
subroutine getRaGlobal(PointID,PG,TG)
	use ZQMPI
	use vectors
	use variables,only:DPoints,ConnectPlane,ConnectVec
	implicit none

	integer,intent(in)::PointID
	type(vector)::PG,TG

	!PG only one
	PG=DPoints(PointID)%tvPG-ConnectVec
	TG=DPoints(PointID)%tvTG

end subroutine getRaGlobal
!********************************************************************
!	getRaLocal:														*
!																	*
!		Return the local PL, TL according to already set connectVec *
!		and connectPlane. These two depend on what you want: to surf*
!		the whole loop, or just to connect to local neighbors.		*
!																	*
!		Whild doing getRaLocal and SetGlobal, tvPL,tvTL,tvPG,tvTG   *
!		does not change. Their plane info does not change either.	*
!		Their connection info does not change either.
!
!																	*
!		1. Connection vector has been established.					*
!		2. Local plane has been set.								*
!																	*
!		Steps:														*
!		1. Plus the connection vector so that the point is moved to *
!			where the local point is.								*
!		2. Transfer the point to local.								*
!********************************************************************
subroutine getRaLocal(PointID,PL,TL)
	use ZQMPI
	use vectors
	use variables,only:ConnectPlane,ConnectVec,DPoints,Miller,GPlanes
	implicit none

	integer,intent(in)::PointID
	type(vector)::PL,TL

	type(vector)::G1
	integer::i_m,i_p

	i_p=ConnectPlane
	i_m=GPlanes(i_p)%iMiller

	G1=DPoints(PointID)%tvPG-ConnectVec
	PL=Miller(i_m)%ES*(G1-GPlanes(i_p)%Origin)
	PL%v(3)=0

	TL=Miller(i_m)%ES*DPoints(PointID)%tvTG

end subroutine getRaLocal
!****************************************************
! TransNextLocal:
!	Get the relative-local-loop position of the next point of
!	the input point, representing the segment.
!	This position determines where the point is on the
!	loop.
!****************************************************
subroutine TransNextLocal(PointID,PL,TL)
	use ZQMPI
	use vectors
	use variables,only:DPoints,ConnectVec,ConnectPlane
	use FunctionMD,only:DeterConnVec
	implicit none

	integer,intent(in)::PointID
	type(vector)::PL,TL
	integer::iNext

	iNext=DPoints(PointID)%iEndP
	ConnectPlane=DPoints(PointID)%iPlane
	ConnectVec=DeterConnVec(iNext,PointID)
	
	call getRaLocal(iNext,PL,TL)

End subroutine TransNextLocal
!****************************************************
! TransNextGlobal:
!	Get the relative-global-loop position of the next point of
!	the input point, representing the segment.
!	This position determines where the point is on the
!	loop.
!****************************************************
subroutine TransNextGlobal(PointID,PL,TL)
	use ZQMPI
	use vectors
	use variables,only:DPoints,ConnectVec,ConnectPlane
	use FunctionMD,only:DeterConnVec
	implicit none

	integer,intent(in)::PointID
	type(vector)::PL,TL
	integer::iNext

	iNext=DPoints(PointID)%iEndP
	ConnectPlane=DPoints(PointID)%iPlane
	ConnectVec=DeterConnVec(iNext,PointID)
	call getRaGlobal(iNext,PL,TL)

End subroutine TransNextGlobal
!**********************************************************************
!	NotInNeiList:
!		Check if the j is already in the neighbor list of i.
!***********************************************************************
logical function NotInNeiList(i,j)
	use ZQMPI
	use vectors
	use variables,only:DPoints
	implicit none

	integer,intent(in)::i,j
	integer::ii,jj,kk
	
	NotInNeiList=.true.

	do ii=1,DPoints(i)%iNumNei
		if(j==DPoints(i)%iaIDOfNei(ii))then
			NotInNeiList=.false.
			exit
		endif
	enddo

end function NotInNeiList
!***************************************************************
!  function VectorAngle: common use, calculate the angle between vectors
!                        Angle is in degree.
!***************************************************************
double precision function VectorAngle(a,b)
	use ZQMPI
	use vectors
	implicit none

	type(vector),intent(in)::a,b

	VectorAngle=(a*b)/(Mag(a)*Mag(b))
	
	if(dabs(VectorAngle)>1.d0)then
		VectorAngle=VectorAngle/dabs(VectorAngle)
	end if
	VectorAngle=dacos(VectorAngle)/dacos(-1.d0)*180.d0

	return
end function VectorAngle

!******************************************************************************
! StopSurfLoop:                                                               *
!       Give a point id, to determine if the surfing of the loop.                 *
!       should be ended.                                                          *
!--                                                                               *
!       Mark intersection point should be careful:                                *
!               if it is not visited before, keep it unvisited; if it is already      *
!       visited, keep it visited, i.e., intersection points keep their status,
!       they are only changed if they are considered as the beginning points
!       of the loop.
!--
!       lSegCriteria: true      =       segment criteria, or
!                                 false =       point criteria
!--
!       Stop conditions:
!       lSegCriteria=true:
!               Next point is:
!               1. an ending point;
!               2. a fixed point;
!               3. a point connected to the beginning point;
!       lSegCriteria=false:
!               Current point is:
!               1. an ending point(type=fixed, iendp=-1);
!               2. an point connected to the beginning point(ienterID), close
!                       loop;
!        5/19/06:
!        if the first point is fixed, should omit this and continue to see next point unless
!       there is no next point or  is point to the beginning point. So, we put the two conditions (no
!       next point---iEndP==-1 and pointing to the beginning point, iNext==iEnterID) in front of
!       the determination of the iDPType. This to make sure any of those two conditions makes
!       the loop to stop, and if they don't, we shall look at the third.
!        This is not needed for lSegCriteria=.false..
!********************************************************************************
logical function StopSurfLoop(PointID,iEnterID,lSegCriteria)
        use ZQMPI
        use vectors
        use variables,only:DPoints,iDPTypeFixed,GPlanes,MAX_NODE
	use SurfMD,only:iSurfCounter
        implicit none

        integer,intent(in)::PointID,iEnterID
        logical,intent(in)::lSegCriteria

        integer::iNext,itmpType,iEnd
        integer::ip1,ip2,im1,im2

        StopSurfLoop=.false.
	iSurfCounter=iSurfCounter+1

	if(iSurfCounter>5*MAX_NODE)then
		StopSurfLoop=.true.
		return
	endif

        if(lSegCriteria)then
                ! determine from next point.
                iNext=DPoints(PointID)%iEndP

                iEnd=DPoints(iNext)%iEndP
                itmpType=DPoints(iNext)%iType

                if(iEnd==-1 .or. iNext==iEnterID .or. (itmpType==iDPTypeFixed .and. iEnd==-1))then
                        StopSurfLoop=.true.
                endif

                ! set the status.
                DPoints(PointID)%lStat=.true.
                if(stopSurfLoop)then
                        DPoints(iNext)%lStat=.true.
                endif
        else !....Point criteria.....
                ! determine from current point.
                iNext=DPoints(PointID)%iEndP

                iEnd=iNext
                itmpType=DPoints(PointID)%iType

                if(iNext==iEnterID .or. iNext==-1 .or. (itmpType==iDPTypeFixed .and. PointID/=iEnterID .and. iNext==-1))then
                        stopSurfLoop=.true.
                endif

                ! set the status. If loop ends at intersection point, next point
                !       will not be set, otherwise, next point also set to be surfed.
                DPoints(PointID)%lStat=.true.

        endif

end function StopSurfLoop
!*****************************************************************
!	iGetLocalIndex:
!		input: iIndex->global index
!		return local index
!*****************************************************************
integer function iGetLocalIndex(iIndex)
	use ZQMPI
	use variables,only:iNPoint
	use MPIModule,only:iaGLIndex,iNumTransP,iaTransList
	implicit none
	
	integer,intent(in)::iIndex
	integer::i,j,k
	
	iGetLocalIndex=-1
	if(iIndex==-1)then
		iGetLocalIndex=-1
	elseif(iaGLIndex(iIndex,1)==iMyid)then ! on local
		iGetLocalIndex=iaGLIndex(iIndex,2)
	else ! in trans list
		do i=1,iNumTransP
			if(iaTransList(i)==iIndex)then
				iGetLocalIndex=iNPoint+i
				exit
			endif
		enddo
	endif

end function iGetLocalIndex
!*********************************************************
! RegroupDP:
!	Determine the loop id for each dislocation.
!*********************************************************
subroutine RegroupDP
	use ZQMPI
	use vectors
	use variables,only:iLoopNum
	implicit none

	external RegroupDPLocal

	iloopNum=0

	call SurfLoop(RegroupDPLocal)

end subroutine RegroupDP
!**************************************************************
!	RegroupDPLocal:
!		Dislocation point ID has been determined and now to assign
!**************************************************************
subroutine RegroupDPLocal(PointID)
	use ZQMPI
	use vectors
	use variables,only:iLoopNum, DPoints,iDPTypeFixed
	implicit none

	integer,intent(in)::PointID
	integer::iBegin,iNext,iCur,iEnterID,looptype,iType
	logical::lContinue,lSegCriteria
	logical::StopSurfLoop

	iEnterID=PointID
	iCur=PointID
	iBegin=DPoints(PointID)%iBeginP
	iType=DPoints(PointID)%iType
	if(iBegin==-1)then
		looptype=1
	else
		looptype=0
	endif

	!----------------------------------!
	lcontinue=.true.
	lSegCriteria=.false.
	iLoopNum=iLoopNum+1

	do while(lcontinue)
		iNext=DPoints(iCur)%iEndP
		
		lContinue=.not.StopSurfLoop(iCur,iEnterID,lSegCriteria)

		if(.not. lcontinue)then
			continue
		endif
		DPoints(iCur)%iLoopID=iLoopNum
		
		iCur=iNext
	enddo

end subroutine RegroupDPLocal
!*********************************************************************
!  setIniDis:
!	Initialize the initial frank-read source as an arc.
!*********************************************************************
subroutine setNewInitDis(NPOINT,PL,TL)
	use ZQMPI
	use vectors
	use variables,only:PI
	implicit none

	integer,intent(in) ::NPOINT
	type(vector),dimension(NPOINT)::PL,TL

	double precision :: X0,Y0,X1,Y1,X2,Y2,LENG,DH,R,U0,K
	double precision :: THETA,BETA
	integer :: iie,i,j,status

	! Initial dislocations
	X0=0.0D0;Y0=0.0D0

	X1=PL(1)%V(1);Y1=PL(1)%V(2)
	X2=PL(2)%V(1);Y2=PL(2)%V(2)

	LENG=DSQRT((X1-X2)*(X1-X2)+(Y1-Y2)*(Y1-Y2))
	DH=0.0002*LENG

	R=LENG*LENG/8.0D0/DH+DH*0.5D0
	THETA=2.0*DASIN(0.5*LENG/R)
	THETA=THETA/(NPOINT-1)

	IF (X1 .GT. X2) THEN
		U0=1
	ELSEIF (X1 .LT. X2) THEN 
		U0=-1
	ELSEIF (X1 .EQ. X2) THEN
		IF( Y1 .GT. Y2) THEN
			U0=1
		ELSE 
			U0=-1
		ENDIF
	ENDIF

	IF (Y1 .EQ.Y2) THEN
		X0=(X1+X2)*0.5D0
		Y0=Y1-U0*(R-DH)
	ELSE
		K=-(X2-X1)/(Y2-Y1)
		IF (K .NE. 0) THEN
			X0=(X1+X2)*0.5-U0*K/DABS(K)*(R-DH)/DSQRT(1+K*K)
		ELSE
			X0=(X1+X2)*0.5+U0*(R-DH)
		ENDIF
		Y0=(Y1+Y2)*0.5-U0*(R-DH)*DABS(K)/DSQRT(1+K*K)
	ENDIF

	DO I=1,NPOINT
		IF ((Y1-Y0)/(X1-X0) .GT. 0) THEN
			BETA=DATAN((Y1-Y0)/(X1-X0))+THETA*(I-1)
		ELSE IF ((Y1-Y0)/(X1-X0) .LT. 0) THEN
			BETA=PI-DATAN(DABS((Y1-Y0)/(X1-X0)))+THETA*(I-1)   
		ELSE
			BETA=THETA*(I-1) 
		ENDIF
		X2=(R*DCOS(BETA))*U0+X0
		Y2=R*DSIN(BETA)*U0+Y0
		PL(I)%V(1)=X2
		PL(I)%V(2)=Y2    
		PL(I)%V(3)=0.0D0
		TL(I)%V(1)=-R*THETA*DSIN(BETA)*U0
		TL(I)%V(2)=R*THETA*DCOS(BETA)*U0
		TL(I)%V(3)=0.0D0                
	ENDDO
end subroutine setNewInitDis

!******************************************************************
!	InMyNeighbor:
!		i: current dislocation point
!		k: possible neighbor
!******************************************************************
logical function InMyNeighbor(i,k)
	use ZQMPI
	use variables,only:DPoints
	implicit none

	integer,intent(in)::i,k
	integer::ii,jj,kk

	InMyNeighbor=.false.

	if(k==-1)then
		InMyNeighbor=.true.
		return
	endif
	if(k==DPoints(i)%iID)then
		InMyNeighbor=.true.
		return
	endif

	do ii=1,DPoints(i)%iNumNei
		if(k==DPoints(i)%iaIDOfNei(ii))then
			InMyNeighbor=.true.
			return
		endif
	enddo

end function InMyNeighbor
!******************************************************************
!	AddToMyNeighbor:
! 
!	i: current point,local index
!	k: possible neighbor,global index
!******************************************************************
subroutine AddToMyNeighbor(i,k)
	use ZQMPI
	use variables,only:DPoints,Max_Neighbor
	implicit none

	integer,intent(in)::i,k
	logical::InMyNeighbor

	if(DPoints(i)%iNumNei<Max_Neighbor .and. .not. InMyNeighbor(i,k))then
		DPoints(i)%iNumNei=DPoints(i)%iNumNei+1
		DPoints(i)%iaIDOfNei(DPoints(i)%iNumNei)=k
	endif

end subroutine AddToMyNeighbor
!*************************************************************************
!	lVirtualLocalPoint:
!		iID: global index
!*************************************************************************
logical function lVirtualLocalPoint(iID)
	use ZQMPI
	use variables,only:iNPOint,DPoints
	use MPIModule,only:iNTotalDPs,iNVLPoints

	integer::i,j

	lVirtualLocalPoint=.false.
	do i=iNPoint+1,iNVLPoints
		if(DPoints(i)%iEndP/=-1.and.DPoints(i)%iID==iID)then  !beginning point and has the same id
			lVirtualLocalPoint=.true.
			exit
		endif
	enddo

end function lVirtualLocalPoint
!*****************************************************************************
! dpFComputeLength:
!	Compute the length of a segment.
!----------------------------------------------------------------------------
!  Modified: ZQ Wang, 02/05/06
!	reset the condition.
!*****************************************************************************
double precision function dpFComputeLength(PointID)
	use ZQMPI
	use vectors
	use variables,only:DPoints
	implicit none

	integer,intent(in)::pointID
	integer::i,j,k
	double precision::u,shap(4,3)
	type(vector)::p1,p2,t1,t2,pp1,pp2

	dpFComputeLength=0.d0
	if(DPoints(PointID)%iEndP/=-1)then
		p1=DPoints(PointID)%tvPL
		t1=DPoints(PointID)%tvTL
		call TransNextLocal(PointID,p2,t2)
		do i=1,21
			u=(i-1)*0.05
			call getshape(shap,u)
			pp2=shap(1,1)*p1+shap(2,1)*t1+shap(3,1)*p2+shap(4,1)*t2
			if(i>1)then
				dpFComputeLength=dpFComputeLength+MAG(pp2-pp1)
			endif
			pp1=pp2
		enddo
	endif

end function dpFComputeLength
!**************************************************************
!	DetermineGPlanes:
!		If a plane exists, return its plane number.
!		Otherwise, add it to the list of planes and return the 
!		plane number.
!**************************************************************
subroutine DetermineGPlanes(OriginL,MillerL,PlaneNum)
	use ZQMPI
	use vectors
	use variables,only:iNPlane,GPlanes,MAX_Plane,Miller,iNumMiller
	implicit none

	type(vector),intent(in)::OriginL,MillerL
	integer::PlaneNum,itmpM

	type(vector)::tmpOrigin,tmpMiller

	integer::i,j,k

	PlaneNum=-1

	itmpM=1
	!....determine plane miller....no. of miller index depending on slip systems for each crystal structure
	do i=1,iNumMiller
		if(MAG(MillerL-Miller(i)%v)==0.d0)then
			itmpM=i
			exit
		endif
	enddo

	!....determine plane origin.....
	do i=1,iNPlane
		tmpOrigin=GPlanes(i)%Origin
		
		!...same origin & same miller index....
		if(MAG(tmpOrigin-OriginL)==0.d0 .and. itmpM==GPlanes(i)%iMiller)then
			PlaneNum=i
			exit
		endif
	enddo

	!....if not exits in the plane array.....
	if(PlaneNum==-1)then
		if(iNPlane<Max_Plane)then
			iNPlane=iNPlane+1
			PlaneNum=iNPlane
			GPlanes(iNPlane)%Origin=OriginL
			GPlanes(iNPlane)%iMiller=itmpM
		else
			PlaneNum=1
		endif
	endif

end subroutine DetermineGPlanes
!**************************************************************
!	AddNewDislocation:
!		Add new dislocation point to the arrays.
!**************************************************************
subroutine AddNewDislocation(PlaneID,BurID,number_frs,PLocal)
	use ZQMPI
	use vectors
	use variables,only:DPoints,iNPoint,NPoint_I
	implicit none

	integer,intent(in)::PlaneID,BurID,number_frs
	type(vector),intent(in)::PLocal(2)

	integer::i,j,k,nPoint
	type(vector),dimension(NPOint_I)::PL,TL
	type(vector)::tmpP,tmpT

	nPoint=NPoint_I
	PL(1)=PLocal(1)
	PL(2)=PLocal(2)
	call setNewInitDis(NPoint,PL,TL)

	!....add new points to the system....
	call AddNewDisPoint(PlaneID,BurID,number_frs,NPOint,PL,TL)

end subroutine AddNewDislocation
!*********************************************************************
!	AddNewDisPoint:
!		Add a new dislocation point to the array.
!*********************************************************************
subroutine AddNewDisPoint(PlaneID,BurID,number_frs,NPoint,PL,TL)
	use ZQMPI
	use vectors
	use variables,only:DPoints,iNPoint,MAX_NEIGHBOR,iDPTypeFree,iDPTypeFixed,&
						MAX_Plane
	implicit none

	integer,intent(in)::PlaneID,BurID,number_frs,NPOINT
	type(vector),intent(in),dimension(NPOINT)::PL,TL

	integer::i,j,k

	do i=1,NPOINT
		iNPOint=iNPoint+1
		j=iNPoint
		
		!...assign values....
		DPoints(j)%iID=iNPoint
		DPoints(j)%iLoopID=number_frs
		if(i==1 .or. i==NPOINT)then
			DPoints(j)%iType=iDPTypeFixed
		else
			DPoints(j)%iType=iDPtypeFree
		endif

		DPoints(j)%tvPL=PL(i)
		DPoints(j)%tvTL=TL(i)

		DPoints(j)%iPlane=PlaneID
		DPoints(j)%iBurgers=BurID

		DPoints(j)%iBeginP=iNPoint-1
		DPoints(j)%iEndP=iNPoint+1
		if(i==1)DPoints(j)%iBeginP=-1     ! beginning is fixed
		if(i==NPoint)DPoints(j)%iEndP=-1  ! ending is fixed
	enddo
	
end subroutine AddNewDisPoint
!******************************************************************************
!	IsCloseLoopPoint:
!		Determine if the point is on a close loop: here close loop is fixed, so
!		such a point has a fixed type and two connections.
!******************************************************************************
logical function IsCloseLoopPoint(i)
	use ZQMPI
	use vectors
	use variables,only:DPoints,iDPTypeFixed
	implicit none
	
	integer,intent(in)::i

	!----------------------------
	IsCloseLoopPoint=.false.
	
	if(DPoints(i)%iType==iDPTypeFixed .and. DPoints(i)%iBeginP/=-1 .and. &
		DPoints(i)%iEndP/=-1)then
		IsCloseLoopPoint=.true.
	endif

end function IsCloseLoopPoint
